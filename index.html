<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Conselho de Classe — Detecção Automática</title>
  <style>
    :root {
      --bg-primary: linear-gradient(135deg, #0f62fe 0%, #ff8c00 50%, #50e3c2 100%);
      --bg-secondary: linear-gradient(135deg, #e3f2fd 0%, #fff3e0 50%, #e8f5e9 100%);
      --bg-card: #ffffff;
      --accent-blue: #0f62fe;
      --accent-orange: #ff8c00;
      --accent-green: #50e3c2;
      --text-primary: #0b1220;
      --text-secondary: #6b7280;
      --border-color: #e6e9ef;
      --shadow: 0 10px 30px rgba(2, 6, 23, 0.1);
      --shadow-hover: 0 15px 40px rgba(2, 6, 23, 0.15);
    }

    body {
      font-family: 'Inter', system-ui, 'Segoe UI', Roboto, Arial, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: var(--bg-primary);
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .wrap {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
    }

    .card {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }

    h1 {
      margin: 0 0 20px;
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-orange));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    label {
      font-size: 14px;
      color: var(--text-secondary);
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    select, input, textarea, button {
      padding: 12px 16px;
      border-radius: 12px;
      border: 2px solid var(--border-color);
      background: white;
      font-size: 14px;
      transition: all 0.3s ease;
      width: 100%;
      box-sizing: border-box;
    }

    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(15, 98, 254, 0.1);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    button {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-orange));
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      padding: 12px 20px;
      transition: all 0.3s ease;
      width: auto;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(15, 98, 254, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    #loadBtn {
      background: linear-gradient(135deg, var(--accent-blue), #3a7cff);
    }

    #scanBtn {
      background: linear-gradient(135deg, var(--accent-orange), #ff9c33);
    }

    #showBtn {
      background: linear-gradient(135deg, var(--accent-green), #6ce9cb);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    th, td {
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      text-align: left;
    }

    thead th {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
      color: white;
      font-weight: 600;
    }

    tbody tr:nth-child(even) {
      background-color: rgba(80, 227, 194, 0.1);
    }

    tbody tr:nth-child(odd) {
      background-color: rgba(15, 98, 254, 0.05);
    }

    tbody tr:hover {
      background-color: rgba(255, 140, 0, 0.1);
    }

    .small {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .note {
      font-size: 14px;
      color: #334155;
    }

    .error {
      color: #b91c1c;
      background-color: rgba(185, 28, 28, 0.1);
      padding: 12px 16px;
      border-radius: 12px;
      margin-top: 16px;
      border-left: 4px solid #b91c1c;
    }

    /* Estilo para dropdowns */
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      padding-right: 40px;
    }

    select option:nth-child(even) {
      background-color: rgba(80, 227, 194, 0.1);
    }

    select option:nth-child(odd) {
      background-color: rgba(15, 98, 254, 0.05);
    }

    @media (max-width: 820px) {
      .row {
        flex-direction: column;
      }
      
      .card {
        padding: 20px;
      }
      
      h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Conselho de Classe — Detecção Automática de Turmas/Bimestres</h1>

      <div class="row">
        <div style="flex:1;min-width:220px">
          <label for="sheetSelect">Série / Aba</label>
          <select id="sheetSelect"></select>
        </div>
        <div style="flex:1;min-width:220px">
          <label for="sheetId">ID da Planilha (SHEET_ID)</label>
          <input id="sheetId" placeholder="Cole o ID da planilha aqui"/>
        </div>
      </div>

      <div class="row">
        <div style="min-width:420px">
          <label for="turmasInput">Lista de turmas (opcional — ajuda a detectar)</label>
          <textarea id="turmasInput" placeholder="Cole a lista de turmas que você tem (cada uma em linha ou separada por espaços)"></textarea>
        </div>
        <div style="min-width:140px">
          <label>&nbsp;</label>
          <div style="display:flex;gap:12px">
            <button id="loadBtn">Carregar & Detectar</button>
            <button id="scanBtn">Re-detectar</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div style="min-width:220px">
          <label for="turmaSelect">Turma</label>
          <select id="turmaSelect"><option>— carregue planilha —</option></select>
        </div>
        <div style="min-width:220px">
          <label for="bimestreSelect">Bimestre</label>
          <select id="bimestreSelect"><option>— selecione —</option></select>
        </div>
        <div style="flex:1;min-width:220px">
          <label for="alunoSelect">Aluno</label>
          <select id="alunoSelect"><option>— selecione —</option></select>
        </div>
        <div style="min-width:120px">
          <label>&nbsp;</label>
          <button id="showBtn">Exibir</button>
        </div>
      </div>

      <div class="row small" id="info">Informações: insira o ID da planilha e clique em Carregar & Detectar.</div>
      <div id="error" class="error" style="display:none;margin-top:16px"></div>

      <div style="margin-top:20px">
        <table id="resultTable" style="display:none">
          <thead>
            <tr><th>Nº</th><th>Aluno</th><th>Disciplina</th><th>Nota (M)</th><th>Faltas (F)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>

<script>
/*  Versão: detecção automática simples
    Estratégia:
      - Carrega aba via gviz/tq
      - Varre todas as células procurando por nomes de turmas (lista do usuário ou regex de padrão tipo "6º Ano A")
      - Para cada turma encontrada, assume que abaixo existe linha de cabeçalho com Nº, Aluno, etc.
      - Detecta bimestres procurando linhas com "1º Bimestre|2º Bimestre|..." (regex).
*/

const sheetSelect = document.getElementById('sheetSelect');
const sheetIdInput = document.getElementById('sheetId');
const turmasInput = document.getElementById('turmasInput');
const loadBtn = document.getElementById('loadBtn');
const scanBtn = document.getElementById('scanBtn');
const turmaSelect = document.getElementById('turmaSelect');
const bimestreSelect = document.getElementById('bimestreSelect');
const alunoSelect = document.getElementById('alunoSelect');
const showBtn = document.getElementById('showBtn');
const info = document.getElementById('info');
const errorDiv = document.getElementById('error');
const resultTable = document.getElementById('resultTable');
const tbody = resultTable.querySelector('tbody');

let SHEET_ID = '';
let sheetHeaders = [];
let sheetRows = [];
let foundTurmas = [];
let parsedStudentsByTurma = {};

function gvizUrl(sheetName){
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
}

async function fetchSheet(sheetName){
  info.textContent = 'Carregando aba...';
  errorDiv.style.display='none';
  const res = await fetch(gvizUrl(sheetName));
  const txt = await res.text();
  const jsonText = txt.replace(/^[^\(]*\(/, '').replace(/\);?$/, '');
  const obj = JSON.parse(jsonText);
  const table = obj.table;
  sheetHeaders = table.cols.map(c => (c && c.label) ? c.label : '');
  sheetRows = table.rows.map(r => {
    const arr = [];
    for (let i=0;i<table.cols.length;i++) arr.push((r.c && r.c[i]) ? r.c[i].v : "");
    return arr;
  });
  info.textContent = `Aba carregada: ${sheetName} — ${sheetRows.length} linhas × ${sheetHeaders.length} colunas`;
  return {headers: sheetHeaders, rows: sheetRows};
}

function normalizeText(s){ return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim(); }

function cellText(r,c){ return normalizeText((sheetRows[r]||[])[c]||'').toString(); }

function findAllOccurrencesOfPatterns(patterns){
  const hits = [];
  for (let r=0;r<sheetRows.length;r++){
    const row = sheetRows[r] || [];
    for (let c=0;c<row.length;c++){
      const v = normalizeText(row[c]||'');
      if (!v) continue;
      for (const p of patterns){
        if (typeof p === 'string'){
          if (v.toLowerCase() === p.toLowerCase()) hits.push({r,c,value:row[c]});
        } else if (p instanceof RegExp){
          if (p.test(v)) hits.push({r,c,value:row[c]});
        }
      }
    }
  }
  return hits;
}

function detectTurmasAndBimestres(userTurmasList){
  foundTurmas = [];
  parsedStudentsByTurma = {};
  const turmaPatterns = [];
  if (userTurmasList && userTurmasList.length>0){
    userTurmasList.forEach(t => turmaPatterns.push(t));
  }
  turmaPatterns.push(/^[0-9]{1,2}\s*º?\s*(ANO|ANO\b).*$/i);
  turmaPatterns.push(/^[0-9]{1,2}\s*ª?\s*(S?SERIE).*$/i);
  turmaPatterns.push(/^(?:[0-9]{1,2}º?\s*Ano\s*[A-Z]|[0-9]ºAno)/i);

  const bimestreRegex = /\b(1|2|3|4)\s*(?:º|o)?\s*bimestre\b|\bbimestre\b/i;

  let hits = [];
  if (userTurmasList && userTurmasList.length>0){
    hits = findAllOccurrencesOfPatterns(userTurmasList);
  }
  if (hits.length === 0){
    hits = findAllOccurrencesOfPatterns(turmaPatterns);
  }

  for (const h of hits){
    const r = h.r; const c = h.c; const raw = h.value;
    let headerRowIndex = null;
    for (let delta=1; delta<=3; delta++){
      const maybe = sheetRows[r+delta] || [];
      const rowText = maybe.map(x=>normalizeText(x||'')).join(' ').toLowerCase();
      if (/\baluno\b/.test(rowText) && /\bno\b|\bnº\b|\bnumero\b|\bn\.o\b|\bnum\b|\bnumero\b/.test(rowText)){
        headerRowIndex = r+delta; break;
      }
    }
    if (headerRowIndex === null) headerRowIndex = r+1;

    const headerRow = sheetRows[headerRowIndex] || [];
    let colStart = c;
    let alunoCol = headerRow.findIndex(x => /aluno/i.test((x||'').toString()));
    let numeroCol = headerRow.findIndex(x => /n\b|numero|n\.|nº/i.test((x||'').toString()));
    if (alunoCol !== -1) colStart = Math.max(0, alunoCol-1);
    if (numeroCol !== -1) colStart = Math.min(colStart, numeroCol);

    let colEnd = colStart;
    for (let cc = colStart; cc < headerRow.length; cc++){
      const val = (headerRow[cc]||'').toString();
      if (val === '' && cc - colEnd > 10) break;
      colEnd = cc;
    }

    const name = (typeof raw === 'string' && raw.toString().trim()) || `Turma @${r+1}:${c+1}`;
    foundTurmas.push({ name, row: r, col:c, headerRowIndex, colStart, colEnd });
  }

  for (const t of foundTurmas){
    const bimestres = [];
    for (let rr = t.headerRowIndex+1; rr < sheetRows.length; rr++){
      const txtLine = (sheetRows[rr]||[]).map(x=>normalizeText(x||'')).join(' ');
      if (!txtLine) continue;
      if (/(1\s*º\s*bimestre|2\s*º\s*bimestre|3\s*º\s*bimestre|4\s*º\s*bimestre|bimestre)/i.test(txtLine)){
        bimestres.push({ title: (sheetRows[rr]||[])[0] || `Bimestre @${rr+1}`, rowIdx: rr });
      }
      if (/(\bano\b|\bserie\b)/i.test(txtLine) && rr > t.row + 1 && rr - t.row > 100) break;
    }

    if (bimestres.length === 0){
      bimestres.push({ title: 'Bimestre único', rowIdx: t.headerRowIndex });
    }

    const ranges = [];
    for (let i=0;i<bimestres.length;i++){
      const start = bimestres[i].rowIdx + 1;
      const end = (i+1 < bimestres.length) ? bimestres[i+1].rowIdx - 1 : Math.min(start + 120, sheetRows.length-1);
      ranges.push({ title: bimestres[i].title, rowStart: start, rowEnd: end });
    }

    const parsed = { bimestres: [] };
    for (const rng of ranges){
      const block = [];
      for (let rr = rng.rowStart; rr <= rng.rowEnd; rr++){
        const slice = (sheetRows[rr] || []).slice(t.colStart, Math.min(t.colEnd+1, sheetHeaders.length));
        const a0 = (slice[0]||'').toString().trim();
        const a1 = (slice[1]||'').toString().trim();
        if (!a0 && !a1) continue;
        block.push({row:rr, values: slice});
      }

      const students = block.map(bt => {
        const vals = bt.values;
        const aluno = vals[0] || '';
        const numero = vals[1] || '';
        const disciplinas = {};
        for (let cc = 2; cc < vals.length; cc += 2){
          const headerCell = (sheetRows[t.headerRowIndex] || [])[t.colStart + cc] || '';
          let base = (headerCell || '').toString().replace(/\bM\b|\bF\b|\(M\)|\(F\)/ig,'').trim();
          if (!base) base = `Disc ${Math.floor((cc-2)/2)+1}`;
          const nota = vals[cc] || '';
          const faltas = (cc+1 < vals.length) ? vals[cc+1] || '' : '';
          disciplinas[base] = { Nota: nota, Faltas: faltas };
        }
        return { Numero: numero, Aluno: aluno, Disciplinas: disciplinas };
      });

      parsed.bimestres.push({ title: rng.title, rowStart: rng.rowStart, rowEnd: rng.rowEnd, students });
    }

    parsedStudentsByTurma[t.name] = parsed;
  }

  return {foundTurmas, parsedStudentsByTurma};
}

function fillTurmaSelect(){
  turmaSelect.innerHTML = '';
  const keys = Object.keys(parsedStudentsByTurma);
  if (keys.length === 0){ turmaSelect.innerHTML = '<option>— nenhuma turma detectada —</option>'; return; }
  keys.forEach(k => { const o = document.createElement('option'); o.value = k; o.textContent = k; turmaSelect.appendChild(o); });
}

function fillBimestresForTurma(turmaName){
  bimestreSelect.innerHTML = '';
  const parsed = parsedStudentsByTurma[turmaName];
  if (!parsed) { bimestreSelect.innerHTML = '<option>— sem dados —</option>'; return; }
  parsed.bimestres.forEach((b,i) => { const o = document.createElement('option'); o.value = i; o.textContent = `${b.title} (${b.rowStart+1}-${b.rowEnd+1})`; bimestreSelect.appendChild(o); });
}

function fillAlunoSelect(turmaName, bIndex){
  alunoSelect.innerHTML = '';
  const parsed = parsedStudentsByTurma[turmaName];
  if (!parsed) return;
  const students = parsed.bimestres[bIndex].students;
  students.forEach(s => { const o = document.createElement('option'); o.value = s.Numero || s.Aluno; o.textContent = `${s.Numero || '-'} - ${s.Aluno || '-'}`; alunoSelect.appendChild(o); });
}

function showAluno(turmaName, bIndex, studentValue){
  tbody.innerHTML = '';
  resultTable.style.display='none';
  const parsed = parsedStudentsByTurma[turmaName];
  if (!parsed) return;
  const students = parsed.bimestres[bIndex].students;
  const aluno = students.find(s => (s.Numero==studentValue) || (s.Aluno==studentValue));
  if (!aluno) { info.textContent = 'Aluno não encontrado'; return; }
  Object.entries(aluno.Disciplinas).forEach(([disc, v]) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${aluno.Numero||''}</td><td>${aluno.Aluno||''}</td><td>${disc}</td><td>${v.Nota||''}</td><td>${v.Faltas||''}</td>`;
    tbody.appendChild(tr);
  });
  resultTable.style.display='table';
  info.textContent = `Exibindo ${aluno.Numero||''} - ${aluno.Aluno||''}`;
}

loadBtn.addEventListener('click', async () => {
  SHEET_ID = sheetIdInput.value.trim();
  const sheetName = sheetSelect.value || '6ºANO';
  if (!SHEET_ID) { errorDiv.style.display='block'; errorDiv.textContent='Cole o ID da planilha antes de carregar.'; return; }
  try{
    await fetchSheet(sheetName);
    const raw = turmasInput.value || '';
    const userTurmas = raw.split(/[\r\n\t]+/).map(x=>x.trim()).filter(Boolean);
    detectTurmasAndBimestres(userTurmas);
    fillTurmaSelect();
    info.textContent = 'Detecção concluída. Selecione a turma e bimestre.';
  } catch(err){ console.error(err); errorDiv.style.display='block'; errorDiv.textContent='Falha ao carregar a planilha. Verifique permissões.'; }
});

scanBtn.addEventListener('click', () => {
  const raw = turmasInput.value || '';
  const userTurmas = raw.split(/[\r\n\t]+/).map(x=>x.trim()).filter(Boolean);
  detectTurmasAndBimestres(userTurmas);
  fillTurmaSelect();
  info.textContent = 'Re-detecção concluída.';
});

turmaSelect.addEventListener('change', () => {
  fillBimestresForTurma(turmaSelect.value);
  fillAlunoSelect(turmaSelect.value, 0);
});

bimestreSelect.addEventListener('change', () => {
  fillAlunoSelect(turmaSelect.value, parseInt(bimestreSelect.value));
});

showBtn.addEventListener('click', () => {
  showAluno(turmaSelect.value, parseInt(bimestreSelect.value), alunoSelect.value);
});

// Inicialização
sheetSelect.innerHTML = '<option value="6ºANO">6ºANO</option><option value="7ºANO">7ºANO</option><option value="8ºANO">8ºANO</option><option value="9ºANO">9ºANO</option>';
</script>
</body>
</html>
